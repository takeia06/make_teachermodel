name: CI / CD (AnomalyGPT)

on:
  push:
    branches: [ main, develop ]
  pull_request:
  workflow_dispatch:

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"

jobs:
  lint_and_unit_cpu:
    name: Lint & Unit (CPU)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Init submodules (robust)
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE/mmdetection"
          git config --global --add safe.directory "$GITHUB_WORKSPACE/code/GroundingDINO"
          git submodule sync --recursive
          git submodule update --init --recursive
          git submodule status

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install minimal deps
        run: |
          python -m pip install -U pip
          pip install ruff black pytest

      - name: Lint (ruff + black --check)
        run: |
          ruff check code tools tests
          black --check code tools tests

      - name: Unit tests (CPU only; fast)
        run: |
          pytest -q tests -k "not gpu"

  gpu_smoke:
    name: Smoke (GPU, self-hosted)
    runs-on: [ self-hosted, gpu ]
    if: false   # Runner 準備できたら true に戻す or 行を削除
    needs: lint_and_unit_cpu
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Init submodules (robust)
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive
          git submodule status

      - name: Show GPU info
        run: nvidia-smi || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install CUDA deps
        run: |
          python -m pip install -U pip wheel
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
          if [ -f requirements.gpu.txt ]; then pip install -r requirements.gpu.txt || true; fi
          if [ -d "mmdetection" ]; then pip install -e mmdetection || true; fi

      - name: Smoke test (GPU path)
        env:
          SMOKE_CKPT: ${{ secrets.SMOKE_CKPT }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python -c "import torch; assert torch.cuda.is_available(); print('CUDA:', torch.cuda.get_device_name(0))"
          pytest -q tests -m gpu
